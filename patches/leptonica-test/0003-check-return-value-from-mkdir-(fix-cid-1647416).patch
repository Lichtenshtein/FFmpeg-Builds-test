From 28f385b6fb716ffff2c553c6a6db729542ecbe1c Mon Sep 17 00:00:00 2001
From: Stefan Weil <sw@weilnetz.de>
Date: Sun, 6 Jul 2025 12:48:21 +0200
Subject: [PATCH] Check return value from mkdir (fix CID 1647416)

This fixes two issues reported by Coverity Scan.

Signed-off-by: Stefan Weil <sw@weilnetz.de>
---
 src/utils2.c | 12 +++++++-----
 1 file changed, 7 insertions(+), 5 deletions(-)

diff --git a/src/utils2.c b/src/utils2.c
index e05abc3ac..82ee10197 100644
--- a/src/utils2.c
+++ b/src/utils2.c
@@ -202,9 +202,9 @@
 
 #ifdef __APPLE__
 #include <unistd.h>
-#include <errno.h>
 #endif
 
+#include <errno.h>     /* for errno */
 #include <string.h>
 #include <stddef.h>
 #include "allheaders.h"
@@ -2174,11 +2174,11 @@ l_uint32  attributes;
     sarraySplitString(sa, subdir, "/");
     n = sarrayGetCount(sa);
     dir = genPathname("/tmp", NULL);
-    ret = 0;   /* don't check ret values with unix because if a directory
-                * exists, mkdir() returns -1  */
        /* Make sure the tmp directory exists */
 #ifndef _WIN32
-    mkdir(dir, 0777);
+    if (mkdir(dir, 0777) != 0 && errno != EEXIST) {
+        ++ret;
+    }
 #else
     attributes = GetFileAttributesA(dir);
     if (attributes == INVALID_FILE_ATTRIBUTES)
@@ -2188,7 +2188,9 @@ l_uint32  attributes;
     for (i = 0; i < n; i++) {
         tmpdir = pathJoin(dir, sarrayGetString(sa, i, L_NOCOPY));
 #ifndef _WIN32
-        mkdir(tmpdir, 0777);
+        if (mkdir(tmpdir, 0777) != 0 && errno != EEXIST) {
+            ++ret;
+        }
 #else
         if (CreateDirectoryA(tmpdir, NULL) == 0)
             ret += (GetLastError() != ERROR_ALREADY_EXISTS);
