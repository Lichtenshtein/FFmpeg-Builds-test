From 9583caa65eddaf1d3a914e2b82a6796cf8a2c76b Mon Sep 17 00:00:00 2001
From: rhythmcache <153998419+rhythmcache@users.noreply.github.com>
Date: Thu, 28 Aug 2025 09:46:59 -0700
Subject: [PATCH] Update CMakeLists.txt

---
 src/CMakeLists.txt | 31 +++++++++++++------------------
 1 file changed, 13 insertions(+), 18 deletions(-)

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index fb10d287..b24b9d43 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -63,29 +63,24 @@ set(CODEBOOKSNEWAMP2_ENERGY
 
 # when crosscompiling we need a native executable
 if(CMAKE_CROSSCOMPILING)
-    set(CMAKE_DISABLE_SOURCE_CHANGES OFF)
-    include(ExternalProject)
-    ExternalProject_Add(codec2_native
-       SOURCE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/..
-       BINARY_DIR ${CMAKE_CURRENT_BINARY_DIR}/codec2_native
-       BUILD_COMMAND ${CMAKE_COMMAND} --build . --target generate_codebook
-       INSTALL_COMMAND ${CMAKE_COMMAND} -E copy ${CMAKE_CURRENT_BINARY_DIR}/codec2_native/src/generate_codebook ${CMAKE_CURRENT_BINARY_DIR}
-       BUILD_BYPRODUCTS ${CMAKE_CURRENT_BINARY_DIR}/generate_codebook
-    )
-    add_executable(generate_codebook IMPORTED)
-    set_target_properties(generate_codebook PROPERTIES
-        IMPORTED_LOCATION ${CMAKE_CURRENT_BINARY_DIR}/generate_codebook)
-    add_dependencies(generate_codebook codec2_native)
-    set(CMAKE_DISABLE_SOURCE_CHANGES ON)
-else(CMAKE_CROSSCOMPILING)
-# Build code generator binaries. These do not get installed.
-    # generate_codebook
+    if(GENERATE_CODEBOOK)
+        message(STATUS "Using prebuilt generate_codebook: ${GENERATE_CODEBOOK}")
+        add_executable(generate_codebook IMPORTED)
+        set_target_properties(generate_codebook PROPERTIES
+            IMPORTED_LOCATION ${GENERATE_CODEBOOK})
+    else()
+        message(FATAL_ERROR
+            "Cross-compiling requires -DGENERATE_CODEBOOK=<path-to-native-generate_codebook>")
+    endif()
+else()
+    # Native build: build code generator binaries. These do not get installed.
     add_executable(generate_codebook generate_codebook.c)
     target_link_libraries(generate_codebook m)
+
     # Make native builds available for cross-compiling.
     export(TARGETS generate_codebook
         FILE ${CMAKE_BINARY_DIR}/ImportExecutables.cmake)
-endif(CMAKE_CROSSCOMPILING)
+endif()
 
 
 # codebook.c
